<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.13"/>
        <!--
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
        -->
        <link href="tabs.css" rel="stylesheet" type="text/css"/>
        <script type="text/javascript" src="jquery.js"></script>
        <title>AVR Weather fetcher: Weather fetching on Atmega32 + ESP8266 + LCD1602</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="gol.js"></script>
        <script type="text/javascript" src="doxy-boot.js"></script>
        <link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">AVR Weather fetcher </a>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Weather fetching on Atmega32 + ESP8266 + LCD1602 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3>About</h3>
<p><a href="http://styczynski.ml/avr-weather-esp8266/">See the full docs!</a></p>
<div class="image">
<object type="image/svg+xml" data="http://styczynski.ml/avr-weather-esp8266/scheme.svg" alt="Scheme"></object>
</div>
<h3>Short description</h3>
<p>This project tends to implement:</p>
<ul>
<li>ESP8266 module messaging from AVR controller</li>
<li>Basic Http request + JSON parsing</li>
<li>LCD support</li>
</ul>
<h3>What does it do?</h3>
<ul>
<li>Boots up (if you press any key) the avr enters</li>
</ul>
<p><code>settings mode</code> and asks for wifi creditentials</p>
<ul>
<li>If no key was pressed during boot then normal procedure takes place</li>
<li>AVR tries to connect to the wifi</li>
<li>Then connects to <code>openweathermap.com</code></li>
<li>Asks politely for weather data for <code>Warsaw</code></li>
<li>Then fetches <code>JSON</code> with the most trivial ways</li>
<li>Displays the data</li>
<li>And sometimes refreshes the collected data :)</li>
</ul>
<h3>Pinout</h3>
<p>The AVR connections are basic and listed below:</p>
<ul>
<li><code>(ATMEGA32) PA0 -&gt; D4 (LCD)</code></li>
<li><code>(ATMEGA32) PA1 -&gt; D5 (LCD)</code></li>
<li><code>(ATMEGA32) PA2 -&gt; D6 (LCD)</code></li>
<li><code>(ATMEGA32) PA3 -&gt; D7 (LCD)</code></li>
<li><code>(ATMEGA32) PA4 -&gt; RS (LCD)</code></li>
<li><code>(ATMEGA32) PA5 -&gt; RW (LCD)</code></li>
<li><code>(ATMEGA32) PA6 -&gt; E (LCD)</code></li>
<li><code>(ATMEGA32) RXD -&gt; TX (ESP8266)</code></li>
<li><code>(ATMEGA32) TXD -&gt; RX (ESP8266)</code></li>
<li><code>(ESP8266) EN -&gt; (ESP8266) VCC</code></li>
</ul>
<p>And of course <code>V0</code>, <code>VCC</code>, <code>GND</code>, <code>VSS</code>, <code>VDD</code>, <code>A</code>, <code>K</code> but they are trivial.</p>
<p>And not mentioned in layout two buttons for settings screen:</p><ul>
<li><code>PD6 -(BUTTON)-&gt; GND</code></li>
<li><code>PD7 -(BUTTON)-&gt; GND</code></li>
</ul>
<p>In settings mode:</p>
<ul>
<li><code>PD6</code> is used have next character functionality.</li>
<li><code>PD7</code> changes current character.</li>
</ul>
<h3>About building</h3>
<p>To build the project do the following:</p>
<ul>
<li>Create release folder e.g. <code>mkdir release</code></li>
<li>Go into that folder <code>cd release</code></li>
<li>Run CMAKE to generate needed makefiles <code>cmake ..</code></li>
<li>Build app using make <code>make</code></li>
<li>Optionally update documentation throught <code>make doc</code></li>
<li>Optionally setup manually the needed fuse bits using <code>avrdude</code>!</li>
<li>Flash controller with <code>make upload</code></li>
<li>Optionally clean build with <code>make clean</code></li>
</ul>
<p>The main controller config is placed in <code>CMakeLists.txt</code> file.</p>
<p>Please change these as you wish:</p>
<div class="fragment"><div class="line"># Variables regarding the AVR chip</div><div class="line">set(MCU   atmega32)</div><div class="line">set(F_CPU 8000000)</div><div class="line">set(BAUD  9600)</div><div class="line">set(PROG_TYPE usbasp)</div><div class="line">set(PROG_ARGS )</div></div><!-- fragment --><p><code>BAUD</code> is not really needed and <code>PROG_ARGS</code> are additional paramters for avrdude.</p>
<p>Basic example config for <code>Atmega328P-PU</code> running (by default) at 1MHz:</p>
<div class="fragment"><div class="line"># Variables regarding the AVR chip</div><div class="line">set(MCU   atmega328p)</div><div class="line">set(F_CPU 1000000)</div><div class="line">set(BAUD  2400)</div><div class="line">set(PROG_TYPE usbasp)</div><div class="line">set(PROG_ARGS )</div></div><!-- fragment --><h3>Some source code</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div><div class="line"></div><div class="line">  <span class="comment">// Init UART</span></div><div class="line">  <a class="code" href="group__avr-uart.html#ga02801836bd557362d71ce28d3dd5135a">uart_init</a>(<a class="code" href="group__avr-uart.html#ga367ff7b5de225ed936a63239ad4adb0b">UART_BAUD_SELECT</a>(2400, F_CPU));</div><div class="line"></div><div class="line">  <span class="comment">// Init buttons</span></div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="comment">//</span></div><div class="line"></div><div class="line">  <span class="comment">// Init LCD</span></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga9af28b2779326b63ff4356e2b1828984">lcd_init</a>(LCD_DISP_ON);</div><div class="line">    <a class="code" href="group__pfleury__lcd.html#gadbf47a5efdf02367ded1ebf8f9edb5fe">lcd_gotoxy</a>(0, 0);</div><div class="line">    <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line"></div><div class="line">  <span class="comment">// Init wifi and connect to the desired network</span></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;Initializing...&quot;</span>);</div><div class="line">  _delay_ms(1000);</div><div class="line">  <a class="code" href="avr-wifi_8h.html#a745aaa256e0f8636cd5d7b63e3035706">wifi_init</a>();</div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// Check if any button was pressed</span></div><div class="line">  <span class="comment">// then go into settings mode :)</span></div><div class="line">  <span class="comment">//</span></div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">//  ...</span></div><div class="line">  <span class="comment">//</span></div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">//  Normal boot sequence</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  normal_boot:</div><div class="line"></div><div class="line">  <span class="comment">// Display greeting on lcd</span></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;Hello&quot;</span>);</div><div class="line">  _delay_ms(1000);</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">  _delay_ms(1500);</div><div class="line"></div><div class="line"></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;Conecting...&quot;</span>);</div><div class="line">  _delay_ms(1000);</div><div class="line"></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;ID: &quot;</span>);</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(USSID);</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;\nPASS: &quot;</span>);</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(PASSWD);</div><div class="line">  _delay_ms(1500);</div><div class="line"></div><div class="line">  <a class="code" href="avr-wifi_8h.html#a19612ec5b0d346a054c869f80dd2c5ec">wifi_connect</a>(USSID, PASSWD);</div><div class="line"></div><div class="line">  <span class="keywordflow">while</span>(1) {</div><div class="line">    <a class="code" href="group__avr-uart.html#gaf5bd6f708c66760b8818eab7f8b8eaad">uart_flush</a>();</div><div class="line"></div><div class="line">    <span class="comment">// Connect to openweathermap</span></div><div class="line">    <a class="code" href="avr-wifi_8h.html#a3a599243de78cdb2d2b21db3f644c5cc">wifi_link_open</a>(<span class="stringliteral">&quot;TCP&quot;</span>, <span class="stringliteral">&quot;api.openweathermap.org&quot;</span>, 80);</div><div class="line"></div><div class="line">    <span class="comment">// Request data from REST api</span></div><div class="line">    <a class="code" href="avr-wifi_8h.html#a35a220a36a4dcb333f6d72114d349562">wifi_send</a>(<span class="stringliteral">&quot;GET /data/2.5/weather?q=warsaw&amp;APPID=cf24c94ac2550178e2ea4e970cd0f416 HTTP/1.1\r\nHost: api.openweathermap.org\r\nConnection: keep-alive\r\nCache-Control: max-age=0\r\n\r\n\r\n&quot;</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/>
</body>
</html>
