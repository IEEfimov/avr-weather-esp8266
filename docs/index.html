<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.13"/>
        <!--
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
        -->
        <link href="tabs.css" rel="stylesheet" type="text/css"/>
        <script type="text/javascript" src="jquery.js"></script>
        <title>AVR Weather fetcher: Weather fetching on Atmega32 + ESP8266 + LCD1602</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="gol.js"></script>
        <script type="text/javascript" src="doxy-boot.js"></script>
        <link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">AVR Weather fetcher </a>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Weather fetching on Atmega32 + ESP8266 + LCD1602 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3>About</h3>
<p><a href="http://styczynski.ml/avr-weather-esp8266/">See the full docs!</a> <a href="https://github.com/isis97/avr-weather-esp8266">And also see this on git!</a></p>
<div class="image">
<img src="view.gif" alt="view.gif"/>
</div>
<h3>Short description</h3>
<p>This project tends to implement:</p>
<p>ESP8266 module messaging from AVR controller Basic Http request + JSON parsing LCD support</p>
<h3>Why it has been made?</h3>
<p>Because of the microcontroller exercises we did on our studies.</p>
<h3>What does it do?</h3>
<p>Boots up (if you press any key) the avr enters</p>
<p><code>settings mode</code> and asks for wifi creditentials</p>
<p>If no key was pressed during boot then normal procedure takes place</p>
<p>AVR tries to connect to the wifi</p>
<p>Then connects to <code>openweathermap.com</code></p>
<p>Asks politely for weather data for <code>Warsaw</code></p>
<p>Then fetches <code>JSON</code> with the most trivial ways</p>
<p>Displays the data</p>
<p>And sometimes refreshes the collected data :)</p>
<h3>Pinout</h3>
<h4>Main wirings</h4>
<p>The AVR connections are basic and listed below:</p>
<div class="fragment"><div class="line">&#39;ATMEGA32&#39;   PA0 -&gt; D4   &#39;LCD&#39;</div><div class="line">&#39;ATMEGA32&#39;   PA1 -&gt; D5   &#39;LCD&#39;</div><div class="line">&#39;ATMEGA32&#39;   PA2 -&gt; D6   &#39;LCD&#39;</div><div class="line">&#39;ATMEGA32&#39;   PA3 -&gt; D7   &#39;LCD&#39;</div><div class="line">&#39;ATMEGA32&#39;   PA4 -&gt; RS   &#39;LCD&#39;</div><div class="line">&#39;ATMEGA32&#39;   PA5 -&gt; RW   &#39;LCD&#39;</div><div class="line">&#39;ATMEGA32&#39;   PA6 -&gt; E    &#39;LCD&#39;</div><div class="line">&#39;ATMEGA32&#39;   RXD -&gt; TX   &#39;ESP8266&#39;</div><div class="line">&#39;ATMEGA32&#39;   TXD -&gt; RX   &#39;ESP8266&#39;</div><div class="line">&#39;ESP8266&#39;    EN  -&gt; VCC  &#39;ESP8266&#39;</div></div><!-- fragment --><p>And of course <code>V0</code>, <code>VCC</code>, <code>GND</code>, <code>VSS</code>, <code>VDD</code>, <code>A</code>, <code>K</code> but they are trivial.</p>
<h4>Buttons</h4>
<p>And not mentioned in layout two buttons for settings screen:</p>
<div class="fragment"><div class="line">&#39;ATMEGA32&#39;  PD6  -(BUTTON)-&gt;  GND</div><div class="line">&#39;ATMEGA32&#39;  PD7  -(BUTTON)-&gt;  GND</div></div><!-- fragment --><p>In settings mode:</p>
<p><code>PD6</code> is used have next character functionality.</p>
<p><code>PD7</code> changes current character.</p>
<p>Schematic of connections (pretty small - try to enlarge with zooming hand):</p>
<div class="image">
<object type="image/svg+xml" data="scheme.svg">scheme.svg</object>
</div>
<p>Notice:**</p>
<p>The <code>ESP8266</code> module was connected to the <code>5V USB</code> plug. The module is designed to work for 3V but working on higher voltage is possible (as demonstrated in this case).*</p>
<p>It's straightforward method and in normal conidtions you should redesign scheme a little and provide 3V voltage source for your wifi module.*</p>
<p>You will probably need logic level shifting form <code>5V (atemga)</code> to <code>3V (esp8266)</code> or you can just run atmega on 3V (notice that LCD needs standard 5V anyway!)*</p>
<h4>Mounting</h4>
<p>You can mount the wires propably on pcb plate I used universal brakboard that does not require soldering but it's rather a messy pile of cables, huh!</p>
<h3>About building</h3>
<h4>Build process</h4>
<p>Warnning!**</p>
<p>Before building make sure all it's configured correctly (see configuration for more details)!*</p>
<p>To build the project do the following:</p>
<p>Create release folder e.g. <code>mkdir release</code></p>
<p>Go into that folder <code>cd release</code></p>
<p>Run CMAKE to generate needed makefiles <code>cmake ..</code></p>
<p>Build app using make <code>make</code></p>
<p>Optionally update documentation throught <code>make doc</code></p>
<p>Optionally setup manually the needed fuse bits using <code>avrdude</code>!</p>
<p>Flash controller with <code>make upload</code></p>
<p>Optionally clean build with <code>make clean</code></p>
<h4>Configuration</h4>
<p>Before continouing make sure that <code>USSID</code> and <code>PASSWD</code> Variables in <code>src/main.c</code> are configured to use with your wifi access point.</p>
<p>Then make sure that <code>APIKEY</code> in line with <code>wifi_send</code> is matching apikey for your openweathermap account. And the url is for location desired by you. See <code>openweathermap api documentation</code> for more details :)</p>
<p>The main controller config is placed in <code>CMakeLists.txt</code> file.</p>
<p>Please change these as you wish:</p>
<div class="fragment"><div class="line"># Variables regarding the AVR chip</div><div class="line">set(MCU   atmega32)</div><div class="line">set(F_CPU 8000000)</div><div class="line">set(BAUD  9600)</div><div class="line">set(PROG_TYPE usbasp)</div><div class="line">set(PROG_ARGS )</div></div><!-- fragment --><p><code>BAUD</code> is not really needed and <code>PROG_ARGS</code> are additional paramters for avrdude.</p>
<p>Basic example config for <code>Atmega328P-PU</code> running (by default) at 1MHz:</p>
<div class="fragment"><div class="line"># Variables regarding the AVR chip</div><div class="line">set(MCU   atmega328p)</div><div class="line">set(F_CPU 1000000)</div><div class="line">set(BAUD  2400)</div><div class="line">set(PROG_TYPE usbasp)</div><div class="line">set(PROG_ARGS )</div></div><!-- fragment --><h3>Some source code</h3>
<p>This snippet presents piece of source code from <code>main.c</code> (and is good introduction to the project insides as well as wifi.h module):</p>
<div class="fragment"><div class="line"><span class="comment">// Handle ESP8266 events</span></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="avr-wifi_8h.html#a2ff370b1e17f60188a76e4f9b122d11a">wifi_event_handler</a>(<span class="keywordtype">int</span> event, <span class="keyword">const</span> <span class="keywordtype">char</span>* input, <span class="keyword">const</span> <span class="keywordtype">int</span> len) {</div><div class="line"></div><div class="line">  <span class="keywordflow">switch</span>(event) {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="avr-wifi_8h.html#ae7e9f5e2d45c2524e192ed588305f552">WIFI_EVENT_ANY</a>: {</div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="comment">// You can display the input</span></div><div class="line">       <span class="comment">// To provide debug info</span></div><div class="line">       <span class="comment">// This kind of event (ANY)</span></div><div class="line">       <span class="comment">// is called for any event</span></div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="keywordflow">return</span>;</div><div class="line">    } <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="avr-wifi_8h.html#ae067a17c45a5f3b8d9905463a15bde1f">WIFI_EVENT_ERROR</a>: {</div><div class="line">       <span class="comment">// We got error!</span></div><div class="line">    } <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="comment">// ESP8266 is not responding</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="avr-wifi_8h.html#a44f829f444be785d22bb96407a39596a">WIFI_EVENT_TIMEOUT</a>: {</div><div class="line">       <span class="comment">// We got timeout!</span></div><div class="line">    } <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Wifi was connected</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="avr-wifi_8h.html#ab0b516f14a8c46ca905a37608a26ae68">WIFI_EVENT_WIFI_CONNECTED</a>: {</div><div class="line">       <span class="comment">// We are conneted to the access point!</span></div><div class="line">    } <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Wifi was disconnected</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="avr-wifi_8h.html#a5ede0ff8a53fe34b1e84773ac61847a0">WIFI_EVENT_WIFI_DISCONNECTED</a>: {</div><div class="line">       <span class="comment">// We are disconneted to the access point!</span></div><div class="line">    } <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Connect to host</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="avr-wifi_8h.html#a8a78537a4880fd8d4412ac2219211de0">WIFI_EVENT_CONNECTED</a>: {</div><div class="line">       <span class="comment">// We are connected to the ip/url specified earlier throug wifi_link_open</span></div><div class="line">    } <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Host sends data</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="avr-wifi_8h.html#a17f8d7cc8608a18ce85d7ea49a853d15">WIFI_EVENT_DATA</a>: {</div><div class="line">      <span class="comment">//</span></div><div class="line">      <span class="comment">// Look for JSON data in response</span></div><div class="line">      <span class="comment">//</span></div><div class="line">      search_json(weather_descr, input, <span class="stringliteral">&quot;description&quot;</span>);</div><div class="line">      search_json(weather_name, input, <span class="stringliteral">&quot;name&quot;</span>);</div><div class="line"></div><div class="line">      search_json(weather_data_buf, input, <span class="stringliteral">&quot;humidity&quot;</span>);</div><div class="line">      sscanf(weather_data_buf, <span class="stringliteral">&quot;%lf&quot;</span>, &amp;weather_humidity);</div><div class="line"></div><div class="line">      search_json(weather_data_buf, input, <span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line">      sscanf(weather_data_buf, <span class="stringliteral">&quot;%d&quot;</span>, &amp;weather_pressure);</div><div class="line"></div><div class="line">      search_json(weather_data_buf, input, <span class="stringliteral">&quot;temp&quot;</span>);</div><div class="line">      sscanf(weather_data_buf, <span class="stringliteral">&quot;%lf&quot;</span>, &amp;weather_temp);</div><div class="line"></div><div class="line"></div><div class="line">      <span class="comment">// We do not need this connection anymore</span></div><div class="line">      <a class="code" href="avr-wifi_8h.html#ade7c8833c6ccd6668513cfc46106bfe3">wifi_link_close</a>();</div><div class="line"></div><div class="line">      <span class="comment">// Format received data</span></div><div class="line">      sprintf(info1, <span class="stringliteral">&quot;%s Weather:&quot;</span>, weather_name);</div><div class="line">      sprintf(info2, <span class="stringliteral">&quot;%s | Temp: %.1lf C | Humidity: %.0lf %% | Pressure: %d HPa&quot;</span>, weather_name, weather_temp-273.15, weather_humidity, weather_pressure );</div><div class="line"></div><div class="line">      <span class="comment">//</span></div><div class="line">      <span class="comment">// Display data continously in text shifting manner</span></div><div class="line">      <span class="comment">//</span></div><div class="line">      <span class="keywordtype">int</span> shift = 0;</div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">int</span> info_len = strlen(info2);</div><div class="line">      <span class="keywordtype">int</span> cycles = 0;</div><div class="line"></div><div class="line">      <span class="keywordflow">while</span>(1) {</div><div class="line">         <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">         <a class="code" href="group__pfleury__lcd.html#gadbf47a5efdf02367ded1ebf8f9edb5fe">lcd_gotoxy</a>(0, 0);</div><div class="line">           <a class="code" href="group__pfleury__lcd.html#gad099247789fb806bfddd24a0f144fc85">lcd_nputs</a>(info1, 16);</div><div class="line">           <a class="code" href="group__pfleury__lcd.html#gadbf47a5efdf02367ded1ebf8f9edb5fe">lcd_gotoxy</a>(0, 1);</div><div class="line">           <a class="code" href="group__pfleury__lcd.html#gad099247789fb806bfddd24a0f144fc85">lcd_nputs</a>(info2+shift, 16);</div><div class="line">           _delay_ms(500);</div><div class="line">           ++shift;</div><div class="line">           <span class="keywordflow">if</span>(shift &gt; info_len - 4) {</div><div class="line">             shift = 0;</div><div class="line">             ++cycles;</div><div class="line">         }</div><div class="line">         <span class="comment">//</span></div><div class="line">         <span class="comment">// End - return to main and then prepare next fetch request</span></div><div class="line">         <span class="comment">//</span></div><div class="line">         <span class="keywordflow">if</span>(cycles &gt; 15) <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      <a class="code" href="group__pfleury__lcd.html#gad099247789fb806bfddd24a0f144fc85">lcd_nputs</a>(<span class="stringliteral">&quot;Update...&quot;</span>, 16);</div><div class="line">      <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">    } <span class="keywordflow">break</span>;</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div><div class="line"></div><div class="line">  <span class="comment">// Init UART</span></div><div class="line">  <a class="code" href="group__avr-uart.html#ga02801836bd557362d71ce28d3dd5135a">uart_init</a>(<a class="code" href="group__avr-uart.html#ga367ff7b5de225ed936a63239ad4adb0b">UART_BAUD_SELECT</a>(2400, F_CPU));</div><div class="line"></div><div class="line">  <span class="comment">// Init buttons</span></div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="comment">//</span></div><div class="line"></div><div class="line">  <span class="comment">// Init LCD</span></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga9af28b2779326b63ff4356e2b1828984">lcd_init</a>(LCD_DISP_ON);</div><div class="line">    <a class="code" href="group__pfleury__lcd.html#gadbf47a5efdf02367ded1ebf8f9edb5fe">lcd_gotoxy</a>(0, 0);</div><div class="line">    <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line"></div><div class="line">  <span class="comment">// Init wifi and connect to the desired network</span></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;Initializing...&quot;</span>);</div><div class="line">  _delay_ms(1000);</div><div class="line">  <a class="code" href="avr-wifi_8h.html#a745aaa256e0f8636cd5d7b63e3035706">wifi_init</a>();</div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// Check if any button was pressed</span></div><div class="line">  <span class="comment">// then go into settings mode :)</span></div><div class="line">  <span class="comment">//</span></div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">//  ...</span></div><div class="line">  <span class="comment">//</span></div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">//  Normal boot sequence</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  normal_boot:</div><div class="line"></div><div class="line">  <span class="comment">// Display greeting on lcd</span></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;Hello&quot;</span>);</div><div class="line">  _delay_ms(1000);</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">  _delay_ms(1500);</div><div class="line"></div><div class="line"></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;Conecting...&quot;</span>);</div><div class="line">  _delay_ms(1000);</div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// Display USSID/PASSWD data on the screen</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <a class="code" href="group__pfleury__lcd.html#gaf8da853dba4b9d5f2aea4e294444e14d">lcd_clrscr</a>();</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;ID: &quot;</span>);</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(USSID);</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(<span class="stringliteral">&quot;\nPASS: &quot;</span>);</div><div class="line">  <a class="code" href="group__pfleury__lcd.html#ga8ffdfcac7638368ff04364c14984266e">lcd_puts</a>(PASSWD);</div><div class="line">  _delay_ms(1500);</div><div class="line"></div><div class="line">  <span class="comment">// Try to connect to the access point</span></div><div class="line">  <a class="code" href="avr-wifi_8h.html#a19612ec5b0d346a054c869f80dd2c5ec">wifi_connect</a>(USSID, PASSWD);</div><div class="line"></div><div class="line">  <span class="keywordflow">while</span>(1) {</div><div class="line">    <span class="comment">// To make sure nothing dumb trash does not come</span></div><div class="line">    <span class="comment">// through UART interface</span></div><div class="line">    <a class="code" href="group__avr-uart.html#gaf5bd6f708c66760b8818eab7f8b8eaad">uart_flush</a>();</div><div class="line"></div><div class="line">    <span class="comment">// Connect to openweathermap</span></div><div class="line">    <a class="code" href="avr-wifi_8h.html#a3a599243de78cdb2d2b21db3f644c5cc">wifi_link_open</a>(<span class="stringliteral">&quot;TCP&quot;</span>, <span class="stringliteral">&quot;api.openweathermap.org&quot;</span>, 80);</div><div class="line"></div><div class="line">    <span class="comment">// Request data from REST api</span></div><div class="line">    <a class="code" href="avr-wifi_8h.html#a35a220a36a4dcb333f6d72114d349562">wifi_send</a>(<span class="stringliteral">&quot;GET /data/2.5/weather?q=warsaw&amp;APPID=cf24c94ac2550178e2ea4e970cd0f416 HTTP/1.1\r\nHost: api.openweathermap.org\r\nConnection: keep-alive\r\nCache-Control: max-age=0\r\n\r\n\r\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Wifi functions will call wifi_event_handler function on any event (it&#39;s callback function)</span></div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/>
</body>
</html>
